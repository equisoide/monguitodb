/*! MonguitoDB v0.0.1 | Tue May 12 2015 23:17:11 | (c) Juan Cuartas | MIT license */
!function(a){function b(){var a={};this.length=0,this.key=function(b){var c=0;for(var d in a)if(c++===b)return d;return null},this.getItem=function(b){return a[b+""]||null},this.setItem=function(b,c){b+="",c+="";var d=this.getItem(b);d!==c&&(a[b]=c,null===d&&this.length++)},this.removeItem=function(b){b+="";var c=this.getItem(b);null!==c&&(delete a[b],this.length--)},this.clear=function(){this.length&&(a={},this.length=0)},this.toString=function(){return"[object Storage]"}}function c(a,b,c,d){var e=function(){return a&&(a.update=g,a.remove=h,a.pretty=i),a},g=function(e){var g="MonguitoDB.Document.update()";if(void 0!==e){f.validateArguments(arguments,1,g),f.validateObject(e,"arg[0]:obj",g);for(var h in e)"_id"!==h&&(a[h]=e[h])}var i=c(),j=i.ids.indexOf(a._id);if(j>=0){var k=d(a._id),l=JSON.stringify(a);return b.setItem(k,l),a}throw new Error(g+", _id:"+a._id+" doesn't exist.")},h=function(){var e="MonguitoDB.Document.remove()";f.validateArguments(arguments,0,e);var g=c(),h=g.ids.indexOf(a._id);if(!(h>=0))throw new Error(e+", _id:"+a._id+" doesn't exist.");b.removeItem(d(a._id)),g.ids.splice(h,1),g.save()},i=function(){var b="MonguitoDB.Document.pretty()";return f.validateArguments(arguments,0,b),f.prettyJSON(a)};return e()}function d(a){var b=function(){return a&&(a.update=c,a.remove=e,a.get=g,a.find=h,a.findOne=i,a.sort=j,a.first=k,a.last=l,a.pretty=m,a.count=n),a},c=function(b){if(void 0!==b){var c="MonguitoDB.Cursor.update()";f.validateArguments(arguments,1,c),f.validateObject(b,"arg[0]:obj",c)}return a.forEach(function(a){a.update(b)}),a},e=function(){var b="MonguitoDB.Cursor.remove()";f.validateArguments(arguments,0,b),a.forEach(function(a){a.remove()}),a.length=0},g=function(b){var c="MonguitoDB.Cursor.get()";return f.validateArguments(arguments,1,c),f.validateDocumentId(b,"arg[0]:documentId",c),a.findOne({_id:b})},h=function(b){if(void 0!==b){var c="MonguitoDB.Cursor.find()";f.validateArguments(arguments,1,c),f.validateObjectOrFunction(b,"arg[0]:query",c)}return d(f.filterArray(a,b))},i=function(b){if(void 0!==b){var c="MonguitoDB.Cursor.findOne()";f.validateArguments(arguments,1,c),f.validateObjectOrFunction(b,"arg[0]:query",c)}return f.firstInArray(f.filterArray(a,b))},j=function(b){var c="MonguitoDB.Cursor.sort()";return f.validateArguments(arguments,1,c),f.validateString(b,"arg[0]:sortExpression",c),d(f.sortArray(a,b))},k=function(){var b="MonguitoDB.Cursor.first()";return f.validateArguments(arguments,0,b),f.firstInArray(a)},l=function(){var b="MonguitoDB.Cursor.last()";return f.validateArguments(arguments,0,b),f.lastInArray(a)},m=function(){var b="MonguitoDB.Cursor.pretty()";return f.validateArguments(arguments,0,b),f.prettyJSON(a)},n=function(){var b="MonguitoDB.Cursor.count()";return f.validateArguments(arguments,0,b),a.length};return b()}function e(a,b){var e=function(a){return f.isValidUUID(a)?a:b+"-"+a},g=function(){var c=a.getItem(b);return c=null===c?{identity:1,ids:[]}:JSON.parse(c),c.save=function(){var c=JSON.stringify(this);a.setItem(b,c)},c},h=function(b){var d="MonguitoDB.Collection.insert()";f.validateArguments(arguments,1,d),f.validateObject(b,"arg[0]:obj",d);var h=g();if(b.hasOwnProperty("_id")){if("uuid"!==b._id)throw new TypeError(d+", invalid _id value, only 'uuid' is allowed.");b._id=f.generateUUID()}else b._id=h.identity++;var i=e(b._id),j=JSON.stringify(b);return a.setItem(i,j),h.ids.push(b._id),h.save(),c(b,a,g,e)},i=function(b){var d="MonguitoDB.Collection.get()";f.validateArguments(arguments,1,d),f.validateDocumentId(b,"arg[0]:documentId",d);var h=e(b),i=a.getItem(h);if(null!==i){var j=JSON.parse(i);return c(j,a,g,e)}return null},j=function(a){if(void 0!==a){var b="MonguitoDB.Collection.find()";f.validateArguments(arguments,1,b),f.validateObjectOrFunction(a,"arg[0]:query",b)}var c=[];return g().ids.forEach(function(a){c.push(i(a))}),"undefined"!=typeof a&&(c=f.filterArray(c,a)),d(c)},k=function(a){if(void 0!==a){var b="MonguitoDB.Collection.findOne()";f.validateArguments(arguments,1,b),f.validateObjectOrFunction(a,"arg[0]:query",b)}return j(a).first()},l=function(){return f.validateArguments(arguments,0,"MonguitoDB.Collection.count()"),g().ids.length},m=function(a,b){var c="MonguitoDB.Collection.update()";f.validateArguments(arguments,2,c),f.validateObjectOrFunction(a,"arg[0]:query",c),f.validateObject(b,"arg[1]:obj",c);var d=j(a);return d.forEach(function(a){a.update(b)}),d},n=function(a){if(void 0!==a){var b="MonguitoDB.Collection.remove()";f.validateArguments(arguments,1,b),f.validateObjectOrFunction(a,"arg[0]:query",b)}j(a).forEach(function(a){a.remove()})};return{insert:h,get:i,find:j,findOne:k,count:l,update:m,remove:n}}var f=f||{};f.filterArray=function(a,b){if("[object Array]"!==Object.prototype.toString.call(a))throw new TypeError("util.filterArray(), invalid arg[0]:array, expecting array.");var c=a.slice(0);if("function"==typeof b)for(var d=0;d<c.length;d++)b(c[d])!==!0&&c.splice(d--,1);else if("object"==typeof b&&null!==b)for(var e=function(a){for(var c in b)if(a[c]!==b[c])return!1;return!0},f=0;f<c.length;f++)e(c[f])||c.splice(f--,1);else if("undefined"!=typeof b)throw new TypeError("util.filterArray(), invalid arg[1]:filter, expecting object or function.");return c},f.sortArray=function(a,b){if("[object Array]"!==Object.prototype.toString.call(a))throw new TypeError("util.sortArray(), invalid arg[0]:array, expecting array.");if("string"!=typeof b)throw new TypeError("util.sortArray(), invalid arg[1]:sort, expecting string.");var c=a.slice(0);return b=b.replace(/ +(?= )/g,"").split(","),c.sort(function(a,c){for(var d=0;d<b.length;d++){var e=b[d].trim().split(" "),f=e[0],g="ASC";if(e.length>1&&(g=e[1].toUpperCase()),"DESC"===g){if(a[f]>c[f])return-1;if(a[f]<c[f])return 1}else{if(a[f]<c[f])return-1;if(a[f]>c[f])return 1}}return 0}),c},f.firstInArray=function(a){if("[object Array]"!==Object.prototype.toString.call(a))throw new TypeError("util.firstInArray(), invalid arg[0]:array, expecting array.");return a.length?a[0]:null},f.lastInArray=function(a){if("[object Array]"!==Object.prototype.toString.call(a))throw new TypeError("util.lastInArray(), invalid arg[0]:array, expecting array.");return a.length?a[a.length-1]:null},f.isValidNaturalNumber=function(a){return"number"==typeof a&&a%1===0&&a>=0},f.isValidVariableName=function(a){return"string"==typeof a&&/^[$A-Z_][0-9A-Z_$]*$/i.test(a)},f.isValidUUID=function(a){if("string"!=typeof a||36!==a.length)return!1;a=a.toUpperCase();for(var b=function(a,b){return[8,13,18,23].indexOf(b)>=0?"-"===a:14===b?"4"===a:19===b?["8","9","A","B"].indexOf(a)>=0:["0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F"].indexOf(a)>=0},c=0;c<a.length;c++)if(!b(a[c],c))return!1;return!0},f.isValidDocumentId=function(a){return f.isValidNaturalNumber(a)||f.isValidUUID(a)},f.isValidStorage=function(a){var b="1E7B9A3B-9D53-469F-BF4E-D056A3BE403C",c="3220B380-2E7A-49BD-9A51-44D6408ED989";try{a.removeItem(b);var d=a.length;if(!f.isValidNaturalNumber(d))return!1;if(a.setItem(b,c),a.getItem(b)!==c)return!1;if(a.length!==d+1)return!1;if(a.removeItem(b),null!==a.getItem(b))return!1;if(a.length!==d)return!1;if("function"!=typeof a.key)return!1;if("function"!=typeof a.clear)return!1}catch(e){return!1}return!0},f.validateArguments=function(a,b,c){if(a.length!==b){var d=null;switch(b){case 0:d="arguments are not allowed.";break;case 1:d="expecting 1 arg, "+a.length+" received.";break;default:d="expecting "+b+" args, "+a.length+" received."}throw new Error(c+", "+d)}},f.validateString=function(a,b,c){if(null===a)throw new TypeError(c+", "+b+" can't be null.");if("string"!=typeof a)throw new TypeError(c+", invalid "+b+", expecting string.")},f.validateObject=function(a,b,c){if(null===a)throw new TypeError(c+", "+b+" can't be null.");if("[object Object]"!==Object.prototype.toString.call(a))throw new TypeError(c+", invalid "+b+", expecting object.")},f.validateObjectOrFunction=function(a,b,c){if(null===a)throw new TypeError(c+", "+b+" can't be null.");if("function"!=typeof a&&"[object Object]"!==Object.prototype.toString.call(a))throw new TypeError(c+", invalid "+b+", expecting object or function.")},f.validateDocumentId=function(a,b,c){if(null===a)throw new TypeError(c+", "+b+" can't be null.");if(!f.isValidDocumentId(a))throw new TypeError(c+", invalid arg[0]:documentId, expecting number or UUID.")},f.prettyJSON=function(a){switch(typeof a){case"string":return a;case"undefined":return"undefined";default:return JSON.stringify(a,null,"	")}},f.generateUUID=function(){var a="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx",b=/[xy]/g,c=function(a){var b=16*Math.random()|0;return"y"===a&&(b=3&b|8),b.toString(16).toUpperCase()};return a.replace(b,c)},a.MonguitoDB=function(a,c){if(f.validateArguments(arguments,2,"MonguitoDB()"),null!==a&&!f.isValidStorage(a))throw new TypeError("MonguitoDB(), invalid arg[0]:storage, expecting storage object.");if(c=[].concat(c),!c.length)throw new TypeError("MonguitoDB(), invalid arg[1]:collections, array can not be empty.");for(var d=0;d<c.length;d++)if("string"!=typeof c[d])throw new TypeError("MonguitoDB(), invalid arg[1]:collections, expecting string or string[].");for(d=0;d<c.length;d++)if(!f.isValidVariableName(c[d]))throw new TypeError("MonguitoDB(), invalid arg[1]:collections '"+c[d]+"' is an invalid collection's name.");for(null===a&&(a=new b),d=0;d<c.length;d++)this[c[d]]||(this[c[d]]=new e(a,c[d]))}}(window);